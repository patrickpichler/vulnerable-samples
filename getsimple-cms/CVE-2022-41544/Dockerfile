FROM --platform=$BUILDPLATFORM ubuntu:latest AS builder

ARG DEBIAN_FRONTEND=noninteractive
ARG GETSIMPLE_VERSION=3.3.16

RUN apt update && apt -y install curl

WORKDIR /app

RUN curl -L -o - https://github.com/GetSimpleCMS/GetSimpleCMS/archive/refs/tags/v${GETSIMPLE_VERSION}.tar.gz | tar xz && \
    mv GetSimpleCMS-$GETSIMPLE_VERSION/* . && \
    rm -rf GetSimpleCMS-$GETSIMPLE_VERSION/

FROM php:7.4-apache

WORKDIR /var/www/html

COPY --from=builder /app .

# Prep container to not start into setup mode
COPY ./assets/data ./data
COPY ./assets/gsconfig.php ./data
RUN rm admin/update.php

# Override the default php.conf to disable the `AllowOverride All` setting
COPY ./assets/docker-php.conf /etc/apache2/conf-enabled/docker-php.conf

# This will disable htaccess in the data folder, which is required to leak the API key
COPY ./assets/root.htaccess .htaccess

RUN mv "$PHP_INI_DIR/php.ini-development" "$PHP_INI_DIR/php.ini" && \
   chown -R www-data:www-data /var/www/html && \
   chmod -R 755 /var/www/html

EXPOSE 80
